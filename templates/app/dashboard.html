{% extends 'layout.html' %}

{% block title %}Dashboard - Eldergate Library{% endblock %}

{% block content %}

{% include 'includes/header.html' %}

<div class="mb-6">
    <div class="relative">
        <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-subtext-light dark:text-subtext-dark">search</span>
        <input class="w-full pl-10 pr-4 py-3 rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark focus:ring-primary focus:border-primary text-text-light dark:text-text-dark" placeholder="Search for books, journal articles and more..." type="text"/>
    </div>
</div>
<section class="mb-8">
    <div class="flex items-center justify-between mb-4">
        <div class="flex space-x-6 border-b border-border-light dark:border-border-dark">
            <button class="pb-2 border-b-2 border-primary text-primary font-semibold">Recommended</button>
            <button class="pb-2 text-subtext-light dark:text-subtext-dark hover:text-primary">Store</button>
        </div>
        <div class="flex items-center space-x-2">
            <span class="text-subtext-light dark:text-subtext-dark">Category</span>
            <select class="rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark focus:ring-primary focus:border-primary text-text-light dark:text-text-dark">
                <option>All</option>
                {% for category in filter_category %}
                    <option value="{{ category.name }}">{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
        <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg">
            <img alt="Book cover for A Teaspoon of Earth and Sea" class="rounded-lg mb-4 w-full h-48 object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuAMx038spWtTHegzNidup0xfiJu8l6UAQ4tTJ1ETyq_SOBV0wNhQFAfxMagd2bTYdzYokxAB165oXnFGS1POdfKkvXC3S2CAE-gm-RIrWrV5_4fhyfrMGBLkcNYuNSTK9-ZINs2BwiC1MOP_4YF88_VIE9ic58P2oy7Q9G8RRqSsCse_nceJ9r8cUj_jqGbI_VvGcifO4eR1onqN0Y1BmO2KB3vhpAYs9kGeFTPCvj4_sI-K3DsOzbVdX2019GvS8ksvAW2qqGooB25"/>
            <span class="text-xs font-semibold text-green-500 bg-green-500/10 py-1 px-2 rounded-full">Fiction</span>
            <h3 class="font-bold text-lg mt-2 text-text-light dark:text-text-dark">A Teaspoon of Earth and Sea long</h3>
            <p class="text-sm text-subtext-light dark:text-subtext-dark">Dina Nayeri</p>
        </div>
        <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg">
            <img alt="Book cover for Here Is Real Magic" class="rounded-lg mb-4 w-full h-48 object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDT2MaeoVEFPTqpehYV2t5_EUilcW9at7j5Ykk1EbmkFIBOvvebsPeB3Q8EtRpUb_CTJOG90-iTDBd_LlRNowQAljxzG-WFkqJf6epaaE5QPUeeAV406eLFTbfIHZ6hQX-aKI-BQwDNbiGX8cfxmgx9JklXG5ffjUycLMT1t8-rZ7wYl9wKbe8jCQOIoVQOLsdkBzSESylJH-SAcPk_MMk0tuKeUCT9keCrGvmfFYWGhgb9GWq9szn-j1Sy354tiXBtgwEB2u3UlzaN"/>
            <span class="text-xs font-semibold text-green-500 bg-green-500/10 py-1 px-2 rounded-full">Fiction</span>
            <h3 class="font-bold text-lg mt-2 text-text-light dark:text-text-dark">Here Is the real Magic</h3>
            <p class="text-sm text-subtext-light dark:text-subtext-dark">Nate Staniforth</p>
        </div>
        <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg">
            <img alt="Book cover for The Water Cure" class="rounded-lg mb-4 w-full h-48 object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBLPWValcuRiJzeBGL35bIY5Nezu0r47wxR_wE3iUqtqfs4_HMsH56bou3YtuA9KRauhSPyY1kvxU1cy1je7REa3Qn9gSrRPJG3lptQehwaVK9a0VxyQP9_KLUz2sQxcN6nq6XN_t7CEVKsQSeX-LfQK3FjD4WxDYYfiRk4hMaHUT_mI38vM5WZBGb5YuYHWFLG47x4NbUHHgGnuj4ewhx4nqTBbd9I2rsh8Z-lITj4z5rJabtnPLIOpieFOWxMr2o4BM2mqn02HEje"/>
            <span class="text-xs font-semibold text-purple-500 bg-purple-500/10 py-1 px-2 rounded-full">Biographic</span>
            <h3 class="font-bold text-lg mt-2 text-text-light dark:text-text-dark">The Water Cure</h3>
            <p class="text-sm text-subtext-light dark:text-subtext-dark">Sophie Mackintosh</p>
        </div>
        <div class="bg-card-light dark:bg-card-dark p-4 rounded-lg">
            <img alt="Book cover for Sugar Run" class="rounded-lg mb-4 w-full h-48 object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDP2QnVJMcvSL09ExsrX9_NsrDuAmQjL3nMyevzooejG0XkJ71lyxYj-oYNqPpkM9FxCJewUC7EsMluxg1BlsMORlSPiu_yT-E6JgZqA-g"/>
            <span class="text-xs font-semibold text-yellow-500 bg-yellow-500/10 py-1 px-2 rounded-full">Mystery</span>
            <h3 class="font-bold text-lg mt-2 text-text-light dark:text-text-dark">Sugar Run</h3>
            <p class="text-sm text-subtext-light dark:text-subtext-dark">Mesha Maren</p>
        </div>
        <div class="bg-blue-500 text-white p-6 rounded-lg flex flex-col items-center justify-center text-center">
            <h3 class="font-bold text-xl mb-2">TEXTBOOKS SHOULD BE PASSED</h3>
            <p class="mb-4">Till 30th June</p>
        </div>
    </div>
</section>
<section>
    <h3 class="text-xl font-bold mb-4 text-text-light dark:text-text-dark">Trending Books</h3>
    <div
        class="bg-card-light dark:bg-card-dark rounded-lg overflow-hidden border border-border-light dark:border-border-dark">
        <table class="w-full text-left">
            <thead class="bg-background-light dark:bg-background-dark/50">
                <tr>
                    <th class="p-4 font-semibold text-sm text-subtext-light dark:text-subtext-dark">Title
                    </th>
                    <th class="p-4 font-semibold text-sm text-subtext-light dark:text-subtext-dark">Author
                    </th>
                    <th class="p-4 font-semibold text-sm text-subtext-light dark:text-subtext-dark">Category
                    </th>
                    <th class="p-4 font-semibold text-sm text-subtext-light dark:text-subtext-dark">
                        Status</th>
                    <th class="p-4 font-semibold text-sm text-subtext-light dark:text-subtext-dark">Price
                    </th>
                    <th class="p-4 font-semibold text-sm text-subtext-light dark:text-subtext-dark">Action
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-border-light dark:divide-border-dark">
                {% for book in trending_books_data %}
                <tr class="text-sm text-text-light dark:text-text-dark">
                    <td class="p-4 flex items-center">
                        <a href="{% url 'book-details' book.id %}">
                            <img alt="Book cover for {{ book.title }}"
                                class="w-8 h-12 object-cover rounded-sm mr-4"
                                src="{{ book.cover_image.url }}" />
                        </a>
                        <a href="{% url 'book-details' book.id %}">{{ book.title }}</a>
                    </td>
                    <td class="p-4">{{ book.author }}</td>
                    <td class="p-4"><span
                            class="{{ book.category_class }}">{{ book.category }}</span>
                    </td>
                    <td class="p-4 text-subtext-light dark:text-subtext-dark">{{ book.price_style.status }}</td>
                    <td class="{{ book.price_style.class }}">{{ book.price_style.text }}</td>
                    <td class="p-4"><button
                        class="border border-primary text-primary py-1 px-4 rounded-full text-sm font-semibold hover:bg-primary hover:text-blue-500 transition-colors" data-action-btn data-action-text="{{ book.action_btn }}" data-book-id="{{ book.id }}">{{ book.action_btn }}</button></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="p-4 text-center text-subtext-light dark:text-subtext-dark">No trending books available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<script>
    const actionBtn = document.querySelectorAll('[data-action-btn]');
    const actionText = document.querySelectorAll('[data-action-text]');
    const bookId = document.querySelectorAll('[data-book-id]');
    const readBookEndpointTemplate = "{% url 'read-book' 0 %}?book_type=dtype";
    const addToCartEndpointTemplate = "{% url 'add-to-cart' 0 %}";
    const readPDFTemplate = "{% url 'pdf-viewer' 0 %}";

    actionBtn.forEach(btn => {
        btn.addEventListener('click', function() {
        
        if (btn.textContent === 'Read now') {
            btn.textContent = 'Processing...';

            const readBookEndpoint = readBookEndpointTemplate.replace('0', btn.dataset.bookId).replace('dtype', 'free');
            const readPDFUrl = readPDFTemplate.replace('0', btn.dataset.bookId);

            fetch(readBookEndpoint)
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Book added to your library successfully!') {
                    btn.textContent = 'Added to Library';
                    window.location.href = readPDFUrl;
                }
                else {
                    NotifyX.warning(data.warning, { duration: 3000, dismissible: true, theme: 'dark' });
                    setTimeout(() => {
                        btn.textContent = 'Read now';
                    }, 3000);

                }
            })
            
        } else {
            btn.textContent = 'Processing...';

            const addToCartEndpoint = addToCartEndpointTemplate.replace('0', btn.dataset.bookId);

            fetch(addToCartEndpoint)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    NotifyX.success(data.message, { duration: 3000, dismissible: true, theme: 'dark' });
                    btn.textContent = 'Added to Cart';
                    setTimeout(() => {
                        btn.textContent = 'Buy now';
                    }, 3000);
                }
                else if (data.status === 'info') {
                    NotifyX.info(data.message, { duration: 3000, dismissible: true, theme: 'dark' });
                    setTimeout(() => {
                        btn.textContent = 'Buy now';
                    }, 3000);
                }
                else {
                    NotifyX.error(data.error, { duration: 3000, dismissible: true, theme: 'dark' });
                }
            })
        }
    })
    })
</script>

{% endblock %}
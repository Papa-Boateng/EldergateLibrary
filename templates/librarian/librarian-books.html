{% extends 'librarian_layout.html' %}

{% block title %}Librarian - Eldergate Library{% endblock %}

{% block content %}

{% include 'includes/header.html' %}
<div class="flex-1 p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Search and Filters -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <!-- SearchBar -->
            <div class="md:col-span-2">
                <label class="flex flex-col w-full">
                    <div
                        class="relative flex w-full flex-1 items-stretch rounded-lg h-12 bg-[#192633]">
                        <span
                            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-[#92adc9]">search</span>
                        <input
                            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-1 focus:ring-primary border border-[#324d67] bg-[#192633] focus:border-primary h-14 placeholder:text-[#92adc9] pl-12 pr-4 py-[15px] text-base font-normal leading-normal"
                            placeholder="Search by title or ISBN..." type="text" id="book-search-input" />
                    </div>
                </label>
            </div>
            <!-- Chips / Filters -->
            <div class="flex gap-4">
                <select class="rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark focus:ring-primary focus:border-primary text-text-light dark:text-text-dark">
                <option>All Categories</option>
                {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
            </select>
            </div>
        </div>
        <!-- Table -->
        <div class="bg-[#111a22] rounded-xl shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-[#192633]">
                            <th
                                class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">
                                Cover</th>
                            <th
                                class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">
                                Title &amp; Author</th>
                            <th
                                class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">
                                Category</th>
                            <th
                                class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">
                                Subcategory</th>
                            <th
                                class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">
                                ISBN</th>
                            <th
                                class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">
                                Date Uploaded</th>
                            <th
                                class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider text-center">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[#324d67]">
                        {% for book_styles in all_books_list_styles %}
                        <tr class="hover:bg-gray-200 dark:hover:bg-gray-800/40 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-md w-12 h-16"
                                    data-alt="Book cover for The Midnight Library"
                                    style='background-image: url("{{ book_styles.book.cover_image.url }}");'>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-semibold text-black dark:text-white">{{ book_styles.book.title }}</div>
                                <div class="text-sm text-gray-600 dark:text-secondary-text">{{ book_styles.book.author }}</div>
                            </td>
                            <td
                                class="{{ book_styles.category_class }}">
                                {{ book_styles.book.category.name }}</td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-secondary-text">
                                {{ book_styles.book.subcategory.name }}</td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-secondary-text">
                                {{ book_styles.isbn_formatted }}</td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-white text-center">
                                {{ book_styles.book.timestamp }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                <button class="text-primary hover:text-blue-500 p-2" data-edit-book data-book-id="{{ book_styles.book.id }}">
                                    <span class="material-symbols-outlined">edit</span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Pagination -->
        <div class="flex justify-between items-center mt-6">
            <span class="text-sm text-[#92adc9]">Showing 1 to 5 of 50 entries</span>
            <div class="flex items-center gap-2">
                <button
                    class="px-3 py-1 rounded-lg bg-[#192633] hover:bg-[#233648] text-white text-sm">Previous</button>
                <button class="px-3 py-1 rounded-lg bg-primary text-white text-sm">1</button>
                <button
                    class="px-3 py-1 rounded-lg bg-[#192633] hover:bg-[#233648] text-white text-sm">2</button>
                <button
                    class="px-3 py-1 rounded-lg bg-[#192633] hover:bg-[#233648] text-white text-sm">3</button>
                <button
                    class="px-3 py-1 rounded-lg bg-[#192633] hover:bg-[#233648] text-white text-sm">Next</button>
            </div>
        </div>
    </div>
</div>

{% include 'modals/librarian/modal-set-subcategory.html' %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('set-subcategory-modal');
    const closeModalBtn = document.getElementById('close-subcategory-modal');
    const bookTableBody = document.querySelector('tbody');

    const modalBookTitle = document.getElementById('modal-book-title');
    const modalBookAuthor = document.getElementById('modal-book-author');
    const modalBookCategory = document.getElementById('modal-book-category');
    const modalBookCover = document.getElementById('modal-book-cover');
    const subcategorySelect = document.getElementById('subcategory-select');
    const subcategoryForm = document.getElementById('set-subcategory-form');

    if (!bookTableBody) return;

    // --- Open Modal --- //
    bookTableBody.addEventListener('click', function (event) {
        const editButton = event.target.closest('[data-edit-book]');
        if (editButton) {
            const bookId = editButton.dataset.bookId;
            const editUrl = `{% url 'edit-book' 0 %}`.replace('0', bookId);

            // 1. Fetch book data
            fetch(editUrl)
                .then(response => response.json())
                .then(bookData => {
                    // 2. Populate modal with book data
                    modalBookTitle.textContent = bookData.title;
                    modalBookAuthor.textContent = `by ${bookData.author}`;
                    modalBookCategory.textContent = `Category: ${bookData.category}`;
                    modalBookCover.style.backgroundImage = `url(${bookData.cover})`;
                    subcategoryForm.action = editUrl; // Set form action URL

                    // 3. Fetch subcategories for the book's category
                    return fetch(`/books/subcategory/?category=${bookData.category_id}`);
                })
                .then(response => response.json())
                .then(subcategories => {
                    // 4. Populate subcategory dropdown
                    subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>'; // Clear existing options
                    subcategories.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub.id;
                        option.textContent = sub.name;
                        subcategorySelect.appendChild(option);
                    });

                    // 5. Show the modal
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                })
                .catch(error => {
                    console.error('Error fetching book data:', error);
                    NotifyX.error('Failed to load book details.', { duration: 3000, theme: 'dark' });
                });
        }
    });

    // --- Close Modal --- //
    closeModalBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // Close modal if clicking outside of it
    modal.addEventListener('click', function (event) {
        if (event.target === modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    });

    // --- Form Submission --- //
    subcategoryForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const url = this.action;

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(data => {
            if (data.status === 200) {
                // NotifyX.success(data.body.message, { duration: 3000, theme: 'dark' });
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                location.reload(); // Reload to see the changes
            } else {
                NotifyX.error(data.body.error, { duration: 3000, theme: 'dark' });
            }
        })
        .catch(error => {
            console.error('Error updating subcategory:', error);
            NotifyX.error('An unexpected error occurred.', { duration: 3000, theme: 'dark' });
        });
    });
});
</script>

{% endblock %}
{% extends 'librarian_layout.html' %}

{% block title %}Librarian - Eldergate Library{% endblock %}

{% block content %}

{% include 'includes/header.html' %}
<div class="flex-1 p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Search and Filters -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <!-- SearchBar -->
            <div class="md:col-span-2">
                <label class="flex flex-col w-full">
                    <div
                        class="relative flex w-full flex-1 items-stretch rounded-lg h-12 bg-[#192633]">
                        <span
                            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-[#92adc9]">search</span>
                        <input
                            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-1 focus:ring-primary border border-[#324d67] bg-[#192633] focus:border-primary h-14 placeholder:text-[#92adc9] pl-12 pr-4 py-[15px] text-base font-normal leading-normal"
                            placeholder="Search by title or ISBN..." type="text" id="book-search-input" />
                    </div>
                </label>
            </div>
            <!-- Chips / Filters -->
            <div class="flex gap-4">
                <select class="rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark focus:ring-primary focus:border-primary text-text-light dark:text-text-dark">
                    <option>All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <!-- Table -->
        <div class="bg-[#111a22] rounded-xl shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left" id="books-table">
                    <thead>
                        <tr class="bg-[#192633]">
                            <th class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">Cover</th>
                            <th class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">Title &amp; Author</th>
                            <th class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">Category</th>
                            <th class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">Subcategory</th>
                            <th class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">ISBN</th>
                            <th class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider">Date Uploaded</th>
                            <th class="px-6 py-4 text-white text-sm font-bold uppercase tracking-wider text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[#324d67]">
                        {% for book in books_data %}
                        <tr class="hover:bg-gray-200 dark:hover:bg-gray-800/40 transition-colors book-row">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-md w-12 h-16"
                                    data-alt="Book cover for The Midnight Library"
                                    style='background-image: url("{{ book.cover_image_url }}");'>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-semibold text-black dark:text-white">{{ book.title }}</div>
                                <div class="text-sm text-gray-600 dark:text-secondary-text">{{ book.author }}</div>
                            </td>
                            <td
                                class="{{ book.category_class }}">
                                {{ book.category_name }}</td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-secondary-text">
                                {{ book.subcategory_name }}</td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-secondary-text">
                                {{ book.isbn }}</td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-white text-center">
                                {{ book.date_added }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                <button class="text-primary hover:text-blue-500 p-2" data-edit-book data-book-id="{{ book.id }}">
                                    <span class="material-symbols-outlined">edit</span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Pagination -->
        <div class="flex justify-between items-center mt-6">
            <span class="text-sm text-[#92adc9]" id="pagination-info"></span>
            <div class="flex items-center gap-2">
                <button class="px-3 py-1 rounded-lg bg-[#192633] hover:bg-[#233648] text-white text-sm pagination-prev">Previous</button>
                <button class="px-3 py-1 rounded-lg bg-[#192633] hover:bg-[#233648] text-white text-sm pagination-next">Next</button>
            </div>
        </div>
    </div>
</div>

{% include 'modals/librarian/modal-set-subcategory.html' %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Custom Table Logic --- //
    const table = document.getElementById('books-table');
    const tableBody = table.querySelector('tbody');
    const allRows = Array.from(tableBody.querySelectorAll('tr.book-row'));
    const searchInput = document.getElementById('book-search-input');
    const categoryFilter = document.querySelector('select');
    const paginationInfo = document.getElementById('pagination-info');
    const prevButton = document.querySelector('.pagination-prev');
    const nextButton = document.querySelector('.pagination-next');
    const pageButtonsContainer = nextButton.parentElement;

    let currentPage = 1;
    const rowsPerPage = 5;

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const categoryId = categoryFilter.value;

        let filteredRows = allRows.filter(row => {
            const title = row.cells[1].textContent.toLowerCase();
            const isbn = row.cells[4].textContent.toLowerCase();
            const categoryCell = row.cells[2];

            const matchesSearch = title.includes(searchTerm) || isbn.includes(searchTerm);
            const matchesCategory = categoryFilter.options[categoryFilter.selectedIndex].text === 'All Categories' || categoryCell.dataset.categoryId === categoryId;

            return matchesSearch && matchesCategory;
        });

        renderTable(filteredRows);
    }

    function renderTable(rowsToRender) {
        tableBody.innerHTML = '';
        const totalRows = rowsToRender.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedItems = rowsToRender.slice(start, end);

        paginatedItems.forEach(row => tableBody.appendChild(row));

        updatePagination(totalRows, totalPages);
    }

    function updatePagination(totalRows, totalPages) {
        const startEntry = totalRows > 0 ? (currentPage - 1) * rowsPerPage + 1 : 0;
        const endEntry = Math.min(currentPage * rowsPerPage, totalRows);
        paginationInfo.textContent = `Showing ${startEntry} to ${endEntry} of ${totalRows} entries`;

        prevButton.disabled = currentPage === 1;
        nextButton.disabled = currentPage === totalPages || totalPages === 0;

        const existingPageButtons = pageButtonsContainer.querySelectorAll('.pagination-page');
        existingPageButtons.forEach(btn => btn.remove());

        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            pageButton.className = 'px-3 py-1 rounded-lg bg-[#192633] hover:bg-[#233648] text-white text-sm pagination-page';
            if (i === currentPage) {
                pageButton.classList.add('bg-primary');
            } else {
                pageButton.classList.remove('bg-primary');
            }
            pageButton.addEventListener('click', () => {
                currentPage = i;
                applyFilters();
            });
            pageButtonsContainer.insertBefore(pageButton, nextButton);
        }
    }

    searchInput.addEventListener('keyup', () => { currentPage = 1; applyFilters(); });
    categoryFilter.addEventListener('change', () => { currentPage = 1; applyFilters(); });
    prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; applyFilters(); } });
    nextButton.addEventListener('click', () => { 
        const totalPages = Math.ceil(allRows.filter(row => row.style.display !== 'none').length / rowsPerPage);
        if (currentPage < totalPages) { 
            currentPage++; 
            applyFilters(); 
        }
    });

    // Initial render
    applyFilters();

    // --- Modal Logic --- //
    const modal = document.getElementById('set-subcategory-modal');
    const closeModalBtn = document.getElementById('close-subcategory-modal');
    const modalBookTitle = document.getElementById('modal-book-title');
    const modalBookAuthor = document.getElementById('modal-book-author');
    const modalBookCategory = document.getElementById('modal-book-category');
    const modalBookCover = document.getElementById('modal-book-cover');
    const subcategorySelect = document.getElementById('subcategory-select');
    const subcategoryForm = document.getElementById('set-subcategory-form');

    if (!tableBody) return;

    tableBody.addEventListener('click', function (event) {
        const editButton = event.target.closest('[data-edit-book]');
        if (editButton) {
            const bookId = editButton.dataset.bookId;
            const editUrl = `{% url 'edit-book' 0 %}`.replace('0', bookId);

            fetch(editUrl)
                .then(response => response.json())
                .then(bookData => {
                    modalBookTitle.textContent = bookData.title;
                    modalBookAuthor.textContent = `by ${bookData.author}`;
                    modalBookCategory.textContent = `Category: ${bookData.category}`;
                    modalBookCover.style.backgroundImage = `url(${bookData.cover})`;
                    subcategoryForm.action = editUrl;

                    return fetch(`/books/subcategory/?category=${bookData.category_id}`);
                })
                .then(response => response.json())
                .then(subcategories => {
                    subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';
                    subcategories.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub.id;
                        option.textContent = sub.name;
                        subcategorySelect.appendChild(option);
                    });

                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                })
                .catch(error => {
                    console.error('Error fetching book data:', error);
                    NotifyX.error('Failed to load book details.', { duration: 3000, theme: 'dark' });
                });
        }
    });

    closeModalBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    modal.addEventListener('click', function (event) {
        if (event.target === modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    });

    subcategoryForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const url = this.action;

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(data => {
            if (data.status === 200) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                location.reload();
            } else {
                NotifyX.error(data.body.error, { duration: 3000, theme: 'dark' });
            }
        })
        .catch(error => {
            console.error('Error updating subcategory:', error);
            NotifyX.error('An unexpected error occurred.', { duration: 3000, theme: 'dark' });
        });
    });
});
</script>

{% endblock %}